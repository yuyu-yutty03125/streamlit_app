import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import plotly.express as px

st.title('売上高と失業率の関係')

st.write("""
        ### 導入
        経済活動において、雇用状況と産業の売上は密接に関連していると考えられるが、その関係は必ずしも自明ではない。景気の変動、消費者行動、企業の投資判断、政府の経済政策など、複数の要因が両者に影響を及ぼすためである。
        """)

st.write("""
        一般に、失業率が低い時期は景気が良好であることが多く、企業の生産活動やサービス需要が活発化するため、売上高は増加しやすいと考えられる。雇用が安定していると、消費者の所得や購買意欲が高まり、外食、旅行、娯楽、物流、広告などのサービス産業の需要が拡大する可能性がある。その結果、失業率の低下は売上高の増加と関連する可能性がある。
        一方で、失業率が高い時期には景気後退や需要の減少が起きやすく、企業はコスト削減や人員整理を行う傾向がある。このような状況では、消費者の支出が抑制され、サービス産業の売上高も減少しやすい。そのため、理論的には「失業率が高いほど売上高が低い」という負の相関が想定される。
        ただし、この関係は単純な因果関係ではなく、政府の経済対策、インフレ、為替変動、技術革新、コロナ禍のような外的ショックなどが影響を及ぼす可能性がある。そのため、データに基づく実証的な検証を行った。
        """)

st.write("""
        ### データ
        """)

# 元となるデータの読み取り
df1 = pd.read_csv('サービス産業の売上高_全国_月_原.csv')
df2 = pd.read_csv('完全失業率_全国_月_季.csv')

# 必要な列だけ抽出
df1 = df1[['時点', 'サービス産業計（売上高）【百万円】']]
df2 = df2[["時点","（季節調整値）完全失業率（男女計）【%】"]]

# 2013年1月以降だけに絞る
df1 = df1[df1['時点'] >= '2013年1月']
df2 = df2[df2['時点'] >= '2013年1月']

# 1つの表にまとめる（時点をキーに結合）
df = pd.merge(df1, df2, on='時点', how='inner')

# 表示するデータを選択する
data = st.selectbox('データを選択してください',
                      ['散布図','表'])  
if data == '散布図':
    data = 'plot'
elif data == '表':
    data = 'table'
else:
    data = 'none'

# 相関係数を計算
corr = df['サービス産業計（売上高）【百万円】'].corr(
    df['（季節調整値）完全失業率（男女計）【%】']
)

# 列名を短くして扱いやすくする（任意だが推奨）
df.columns = ['時間', '売上高（百万円）', '失業率（%）']

if data == 'plot':
    # 散布図の作成
    fig = px.scatter(
        df,
        x='失業率（%）',
        y='売上高（百万円）',
        title=f"相関係数: {corr:.3f}",
        labels={
            '失業率（%）': '完全失業率（%）',
            '売上高（百万円）': 'サービス産業売上高（百万円）'
        },
        trendline='ols'   # 回帰直線
    )
    st.plotly_chart(fig)


elif data == 'table':
    # 表の表示
    st.dataframe(df)

# st.dataframe(df1)
# st.dataframe(df2)

# 結果
st.write("""
        ### 分かる内容
        表に示されたデータを見ると、2013年以降の各月におけるサービス産業の売上高と完全失業率が対応しており、両者の変動を時系列的に比較できる。散布図では、横軸に失業率、縦軸に売上高を取り、各時点のデータがプロットされている。その結果、全体としては失業率が低いほど売上高が高い傾向が見られ、右下がりの関係が確認できる。
        また、算出された相関係数は-0.347と負の値を示しており、失業率が上昇するにつれて売上高が減少する傾向が統計的に確認された。このことは、景気の悪化が雇用とサービス産業の売上に同時に影響を及ぼしている可能性を示している。
        ただし、散布図にはばらつきも存在し、すべての時点で厳密な比例関係が成り立っているわけではない。特定の時期には、失業率が比較的低くても売上が伸び悩んでいる場合や、その逆のケースも見られる。したがって、売上高と失業率の関係は一定の負の相関を示すものの、他の要因も考慮する必要があると結論づけられる。
        """)